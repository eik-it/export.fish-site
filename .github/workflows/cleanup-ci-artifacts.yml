name: Cleanup and squash _ci branch

on:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger
    inputs:
      retention_days:
        description: 'Number of days to retain artifacts (default: 30)'
        required: false
        default: '30'
        type: number

permissions:
  contents: write # Need write permission to push to _ci branch

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout _ci branch
        uses: actions/checkout@v4
        with:
          ref: _ci
          fetch-depth: 0 # Need full history to check commit dates

      - name: Setup git config
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Clean up artifacts older than retention period
        id: cleanup
        run: |
          # Get retention days from input or use default
          RETENTION_DAYS="${{ github.event.inputs.retention_days || '30' }}"
          echo "Retention period: $RETENTION_DAYS days"

          # Calculate cutoff date
          CUTOFF_DATE=$(date -d "$RETENTION_DAYS days ago" +%s)
          echo "Cutoff date: $(date -d '@$CUTOFF_DATE' '+%Y-%m-%d %H:%M:%S')"

          # Track statistics
          TOTAL_FILES=0
          DELETED_FILES=0

          # Get list of all PNG files with their commit dates
          echo "Analyzing files in _ci branch..."

          for FILE in *.png; do
            if [ ! -f "$FILE" ]; then
              continue
            fi

            TOTAL_FILES=$((TOTAL_FILES + 1))

            # Get the commit date for this file (when it was added)
            COMMIT_DATE=$(git log -1 --format=%ct -- "$FILE")

            if [ -z "$COMMIT_DATE" ]; then
              echo "Warning: Could not get commit date for $FILE, skipping"
              continue
            fi

            # Compare dates
            if [ "$COMMIT_DATE" -lt "$CUTOFF_DATE" ]; then
              DELETED_FILES=$((DELETED_FILES + 1))
              echo "Deleting old artifact: $FILE ($(date -d "@$COMMIT_DATE" '+%Y-%m-%d'))"
              git rm "$FILE"
            fi
          done

          echo ""
          echo "=== Cleanup Summary ==="
          echo "Total artifacts: $TOTAL_FILES"
          echo "Deleted artifacts: $DELETED_FILES"
          echo "Remaining artifacts: $((TOTAL_FILES - DELETED_FILES))"

          # Export variables for PR body
          echo "TOTAL_FILES=$TOTAL_FILES" >> $GITHUB_ENV
          echo "DELETED_FILES=$DELETED_FILES" >> $GITHUB_ENV
          echo "REMAINING_FILES=$((TOTAL_FILES - DELETED_FILES))" >> $GITHUB_ENV
          echo "CUTOFF_DATE=$(date -d '@$CUTOFF_DATE' '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "RETENTION_DAYS=$RETENTION_DAYS" >> $GITHUB_ENV

          # Set output to indicate if changes were made
          if [ "$DELETED_FILES" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Squash all commits into one and push
        if: steps.cleanup.outputs.has_changes == 'true'
        run: |
          # Get list of all files currently in the branch
          git add -A

          # Count commits in _ci branch
          COMMIT_COUNT=$(git rev-list --count HEAD)
          echo "Current commits in branch: $COMMIT_COUNT"
          echo "Squashing $COMMIT_COUNT commits into one..."

          # Create orphan branch with same content but only one commit
          TEMP_BRANCH="_ci-squashed-temp"
          git checkout --orphan "$TEMP_BRANCH"

          # Stage all files
          git add -A

          # Create single commit using multiple -m flags for multiline message
          git commit \
            -m "_ci cleanup of viz reg files" \
            -m "Automated weekly maintenance of visual regression artifacts." \
            -m "Cleanup summary:" \
            -m "- Total artifacts before: $TOTAL_FILES" \
            -m "- Artifacts deleted (>$RETENTION_DAYS days): $DELETED_FILES" \
            -m "- Remaining artifacts: $REMAINING_FILES" \
            -m "- Cutoff date: $CUTOFF_DATE" \
            -m "- Retention period: $RETENTION_DAYS days" \
            -m "" \
            -m "This branch stores diff and crop images from visual regression tests." \
            -m "Images are content-addressed using SHA256 hashing for deduplication."

          # Force push to _ci branch (replaces entire history)
          echo "Force pushing squashed commit to _ci branch..."
          git push -f origin HEAD:_ci

          echo "✅ Cleanup complete!"
          echo "   - Deleted: $DELETED_FILES files"
          echo "   - Remaining: $REMAINING_FILES files"
          echo "   - Commits squashed: $COMMIT_COUNT → 1"

      - name: No changes needed
        if: steps.cleanup.outputs.has_changes == 'false'
        run: |
          echo "✅ No old artifacts to clean up - _ci branch is already clean!"
