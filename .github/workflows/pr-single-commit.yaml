name: PR Single Commit Policy

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-single-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for single commit
        run: |
          # Get the number of commits in the PR (excluding GitHub's automatic merge commits)
          COMMIT_COUNT=$(git rev-list --count --no-merges origin/${{ github.base_ref }}..HEAD)

          echo "Number of commits in PR: $COMMIT_COUNT"

          if [ "$COMMIT_COUNT" -eq 1 ]; then
            echo "✅ PR contains exactly one commit - policy satisfied"
            exit 0
          else
            echo "❌ PR contains $COMMIT_COUNT commits - policy violation"
            echo ""
            echo "This repository enforces a single commit per PR policy."
            echo ""
            echo "Please squash your commits into one:"
            echo "  git rebase -i origin/${{ github.base_ref }}"
            echo "  # Change all but the first 'pick' to 'squash' (or 's')"
            echo "  git push --force-with-lease"
            echo ""
            echo "Commits in this PR:"
            git log --oneline --no-merges origin/${{ github.base_ref }}..HEAD
            exit 1
          fi
