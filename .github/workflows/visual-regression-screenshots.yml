name: Generate Visual Regression Screenshots
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'public/**'
      - 'e2e/**'
      - 'astro.config.mjs'
      - 'tailwind.config.*'
      - 'playwright.config.ts'
permissions:
  contents: write
  pull-requests: write
jobs:
  capture:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [base, pr]
    steps:
      - name: Checkout ${{ matrix.branch }} branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch == 'base' && github.event.pull_request.base.ref || github.head_ref }}

      - name: Capture screenshots
        uses: netbrain/visual-regression-action@v1
        with:
          mode: capture
          playwright-command: 'npm run build && npx playwright test'
          artifact-name: screenshots-${{ matrix.branch }}

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.branch }}
          path: screenshots/

  compare:
    runs-on: ubuntu-latest
    needs: capture
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download base screenshots
        uses: actions/download-artifact@v4
        with:
          name: screenshots-base
          path: screenshots-base

      - name: Download PR screenshots
        uses: actions/download-artifact@v4
        with:
          name: screenshots-pr
          path: screenshots-pr

      - name: Compare screenshots
        uses: netbrain/visual-regression-action@v1
        with:
          mode: compare
          ci-branch-name: '_ci'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket-name: ${{ secrets.R2_BUCKET_NAME }}
          r2-public-url: ${{ secrets.R2_PUBLIC_URL }}
          output-format: 'animated-gif'
          gif-frame-delay: '500'
