---
/**
 * Organization number field with auto-lookup from Brønnøysundregistrene
 */
interface Props {
  required?: boolean;
}

const { required = true } = Astro.props;
---

<div class="form-field">
  <label for="field-organizationNumber" class="block text-sm font-medium text-gray-700 mb-1">
    Organisasjonsnummer
    {required && <span class="text-red-500 ml-1">*</span>}
  </label>

  <div class="relative">
    <input
      type="text"
      id="field-organizationNumber"
      name="organizationNumber"
      required={required}
      placeholder="f.eks. 123456789"
      inputmode="numeric"
      pattern="[0-9]{9}"
      maxlength="9"
      class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
      aria-describedby="field-organizationNumber-help"
      aria-invalid="false"
    />
    <div
      id="lookup-spinner"
      class="absolute right-3 top-1/2 -translate-y-1/2 hidden"
      aria-label="Looking up company..."
    >
      <svg
        class="animate-spin h-5 w-5 text-primary"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
    </div>
  </div>

  <p id="field-organizationNumber-help" class="text-sm text-gray-500 mt-1">
    9-sifret organisasjonsnummer fra Brønnøysundregistrene
  </p>

  <p
    id="field-organizationNumber-error"
    class="text-sm text-red-600 mt-1 hidden"
    role="alert"
    aria-live="polite"
  >
  </p>

  <p
    id="field-organizationNumber-success"
    class="text-sm text-green-600 mt-1 hidden"
    role="status"
    aria-live="polite"
  >
  </p>
</div>

<script>
  // Organization number lookup functionality
  const orgNumberInput = document.getElementById(
    'field-organizationNumber'
  ) as HTMLInputElement;
  const companyNameInput = document.getElementById(
    'field-companyName'
  ) as HTMLInputElement;
  const addressInput = document.getElementById(
    'field-companyAddress'
  ) as HTMLInputElement;
  const municipalityInput = document.getElementById(
    'field-companyMunicipality'
  ) as HTMLInputElement;
  const spinner = document.getElementById('lookup-spinner');
  const errorEl = document.getElementById('field-organizationNumber-error');
  const successEl = document.getElementById(
    'field-organizationNumber-success'
  );

  let lookupTimeout: number | null = null;

  orgNumberInput?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    const value = target.value.replace(/\s/g, '');

    // Clear previous timeout
    if (lookupTimeout) {
      clearTimeout(lookupTimeout);
    }

    // Clear messages
    if (errorEl) errorEl.classList.add('hidden');
    if (successEl) successEl.classList.add('hidden');
    target.classList.remove('error');

    // Only lookup if we have exactly 9 digits
    if (value.length === 9 && /^\d{9}$/.test(value)) {
      // Debounce lookup by 500ms
      lookupTimeout = setTimeout(() => {
        lookupCompany(value);
      }, 500);
    }
  });

  async function lookupCompany(orgNumber: string) {
    if (!spinner || !errorEl || !successEl) return;

    // TEMPORARY: Whitelist test org numbers when posting to test.export.fish
    // This can be removed once the form posts directly to export.fish backend
    const TEST_ORG_NUMBERS = ['910337727', '315149762', '910337729'];

    // Check if the form posts to test.export.fish (not production export.fish)
    const registrationForm = document.getElementById('registration-form');
    const apiUrl = registrationForm?.getAttribute('data-api-url') || '';
    const isTestBackend = apiUrl.includes('test.export.fish');

    if (isTestBackend && TEST_ORG_NUMBERS.includes(orgNumber)) {
      // Skip Brreg lookup for whitelisted test organizations
      successEl.textContent = `Test organisasjon: ${orgNumber}`;
      successEl.classList.remove('hidden');
      return;
    }

    try {
      spinner.classList.remove('hidden');
      errorEl.classList.add('hidden');
      successEl.classList.add('hidden');

      // Call Brønnøysundregistrene API directly
      const response = await fetch(
        `https://data.brreg.no/enhetsregisteret/api/enheter/${orgNumber}`
      );

      if (!response.ok) {
        if (response.status === 404) {
          throw new Error('Fant ikke bedriften i Brønnøysundregistrene');
        }
        throw new Error('Kunne ikke slå opp bedrift');
      }

      const data = await response.json();

      // Auto-fill company name
      if (companyNameInput && data.navn) {
        companyNameInput.value = data.navn;
        companyNameInput.dispatchEvent(new Event('input', { bubbles: true }));
      }

      // Auto-fill address from forretningsadresse or postadresse
      const addr = data.forretningsadresse || data.postadresse;
      if (addr) {
        // Fill address field (street, postal code, city)
        if (addressInput) {
          const addressParts: string[] = [];

          // Add street address lines
          if (addr.adresse && Array.isArray(addr.adresse)) {
            addressParts.push(addr.adresse.join(', '));
          }

          // Add postal code and city
          if (addr.postnummer && addr.poststed) {
            addressParts.push(`${addr.postnummer} ${addr.poststed}`);
          }

          addressInput.value = addressParts.join(', ');
          addressInput.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // Fill municipality
        if (municipalityInput && addr.kommune) {
          municipalityInput.value = addr.kommune;
          municipalityInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
      }

      // Show success message
      successEl.textContent = `Fant: ${data.navn}`;
      successEl.classList.remove('hidden');
    } catch (error) {
      console.error('Company lookup failed:', error);
      errorEl.textContent =
        error instanceof Error
          ? error.message
          : 'Kunne ikke finne bedrift. Vennligst sjekk organisasjonsnummeret.';
      errorEl.classList.remove('hidden');
      orgNumberInput?.classList.add('error');

      // Clear company name, address, and municipality if lookup failed
      if (companyNameInput) {
        companyNameInput.value = '';
      }
      if (addressInput) {
        addressInput.value = '';
      }
      if (municipalityInput) {
        municipalityInput.value = '';
      }
    } finally {
      spinner.classList.add('hidden');
    }
  }
</script>

<style>
  .form-field input.error {
    border-color: #ef4444;
    background-color: #fef2f2;
  }

  .form-field input:focus.error {
    ring-color: #ef4444;
  }
</style>
