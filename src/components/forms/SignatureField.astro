---
/**
 * Signature field component using signature_pad library
 * Allows users to draw their signature with mouse/touch
 * Stores signature as SVG data URI
 */
interface Props {
  label: string;
  name: string;
  required?: boolean;
  helpText?: string;
}

const {
  label,
  name,
  required = false,
  helpText,
} = Astro.props;

const id = `field-${name}`;
const canvasId = `${id}-canvas`;
---

<div class="form-field">
  <label for={canvasId} class="block text-sm font-medium text-gray-700 mb-1">
    {label}
    {required && <span class="text-red-500 ml-1">*</span>}
  </label>

  <div class="signature-container border border-gray-300 rounded-lg bg-white">
    <canvas
      id={canvasId}
      class="signature-canvas w-full touch-none"
      aria-label={label}
      aria-describedby={helpText ? `${id}-help` : undefined}
    />

    <div class="signature-controls flex justify-end p-2 border-t border-gray-200">
      <button
        type="button"
        id={`${id}-clear`}
        class="text-sm text-gray-600 hover:text-gray-900 px-3 py-1 rounded hover:bg-gray-100 transition-colors"
      >
        Tøm signatur
      </button>
    </div>
  </div>

  {
    helpText && (
      <p id={`${id}-help`} class="text-sm text-gray-500 mt-1">
        {helpText}
      </p>
    )
  }

  <p
    id={`${id}-error`}
    class="text-sm text-red-600 mt-1 hidden"
    role="alert"
    aria-live="polite"
  >
  </p>

  <!-- Hidden input to store signature data -->
  <input
    type="hidden"
    id={id}
    name={name}
    data-signature-field
    aria-invalid="false"
  />
</div>

<script>
  import SignaturePad from 'signature_pad';

  // Initialize all signature fields on the page
  document.querySelectorAll('[data-signature-field]').forEach((hiddenInput) => {
    const input = hiddenInput as HTMLInputElement;
    const fieldName = input.name;
    const canvasId = `field-${fieldName}-canvas`;
    const clearButtonId = `field-${fieldName}-clear`;

    const canvas = document.getElementById(canvasId) as HTMLCanvasElement;
    const clearButton = document.getElementById(clearButtonId);
    const container = canvas?.closest('.signature-container') as HTMLElement;

    if (!canvas) return;

    // Set canvas size based on container
    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();

      // Save existing signature data if any
      const existingData = signaturePad.isEmpty() ? null : signaturePad.toDataURL('image/svg+xml');

      canvas.width = rect.width * ratio;
      canvas.height = 200 * ratio; // Fixed height of 200px
      canvas.getContext('2d')?.scale(ratio, ratio);

      // Restore signature if it existed
      if (existingData) {
        signaturePad.fromDataURL(existingData);
      }
    }

    // Initialize SignaturePad
    const signaturePad = new SignaturePad(canvas, {
      backgroundColor: 'rgb(255, 255, 255)',
      penColor: 'rgb(0, 0, 0)',
    });

    // Initial resize
    resizeCanvas();

    // Resize on window resize
    let resizeTimeout: number;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(resizeCanvas, 100) as unknown as number;
    });

    // Update hidden input when signature changes
    signaturePad.addEventListener('endStroke', () => {
      if (!signaturePad.isEmpty()) {
        const dataURL = signaturePad.toDataURL('image/svg+xml');
        input.value = dataURL;

        // Clear error state when signature is added
        container?.classList.remove('error');
        input.setAttribute('aria-invalid', 'false');

        const errorEl = document.getElementById(`field-${fieldName}-error`);
        if (errorEl) {
          errorEl.textContent = '';
          errorEl.classList.add('hidden');
        }
      }
    });

    // Clear button
    clearButton?.addEventListener('click', () => {
      signaturePad.clear();
      input.value = '';
    });

    // Form validation support
    const form = canvas.closest('form');
    form?.addEventListener('submit', (e) => {
      if (signaturePad.isEmpty() && input.hasAttribute('required')) {
        e.preventDefault();

        // Show error state
        container?.classList.add('error');
        input.setAttribute('aria-invalid', 'true');

        const errorEl = document.getElementById(`field-${fieldName}-error`);
        if (errorEl) {
          errorEl.textContent = 'Signatur er påkrevd';
          errorEl.classList.remove('hidden');
        }

        // Scroll to error
        canvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  });
</script>

<style>
  .signature-container {
    transition: border-color 0.2s, background-color 0.2s;
  }

  .signature-container:focus-within {
    border-color: #0066cc;
    box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
  }

  .signature-container.error {
    border-color: #ef4444;
    background-color: #fef2f2;
  }

  .signature-container.error:focus-within {
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1);
  }

  .signature-canvas {
    height: 200px;
    cursor: crosshair;
  }
</style>
