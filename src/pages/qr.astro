---
import Layout from '../layouts/Layout.astro';
import { Image } from 'astro:assets';
import logo from '../assets/logo.png';

// Get subdomain from query parameter
const subdomain = Astro.url.searchParams.get('subdomain') || '';
---

<Layout
  title="QR-kode Generator - export.fish"
  description="Generer QR-kode for din export.fish app"
>
  <main class="min-h-screen bg-gray-50 pt-32 pb-16 px-4">
    <div class="max-w-2xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">
          QR-kode Generator
        </h1>
        <p class="text-lg text-gray-600">
          Generer QR-kode for din export.fish app
        </p>
      </div>

      <!-- Input Section -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <label for="subdomain-input" class="block text-sm font-medium text-gray-700 mb-2">
          Subdomene
        </label>
        <div class="flex gap-2">
          <input
            type="text"
            id="subdomain-input"
            value={subdomain}
            placeholder="mittfirma"
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <button
            id="generate-btn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors"
          >
            Generer
          </button>
        </div>
        <p class="text-sm text-gray-500 mt-2">
          QR-koden vil peke til: <span id="url-preview" class="font-mono font-semibold">https://{subdomain || 'mittfirma'}.export.fish</span>
        </p>
      </div>

      <!-- QR Code Display -->
      <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <div id="qr-container" class="flex justify-center items-center min-h-[320px]">
          <div class="text-center text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
            </svg>
            <p class="text-lg font-medium">Skriv inn et subdomene og klikk Generer</p>
          </div>
        </div>
      </div>

      <!-- Download Options -->
      <div id="download-section" class="hidden">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Last ned</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
          <button
            id="download-png"
            class="bg-white hover:bg-gray-50 border-2 border-gray-300 text-gray-700 px-6 py-4 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            PNG
          </button>
          <button
            id="download-svg"
            class="bg-white hover:bg-gray-50 border-2 border-gray-300 text-gray-700 px-6 py-4 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
            </svg>
            SVG
          </button>
          <button
            id="print-btn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
            </svg>
            Skriv ut
          </button>
        </div>
      </div>

      <!-- Print-only content -->
      <div id="print-content" class="hidden print:block print:p-8">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold mb-2">export.fish</h1>
          <p class="text-xl text-gray-600" id="print-url"></p>
        </div>
        <div id="print-qr" class="flex justify-center mb-8"></div>
        <div class="text-center text-gray-600">
          <p>Scan QR-koden for å åpne appen</p>
        </div>
      </div>
    </div>
  </main>

  <style>
    @media print {
      header, nav, #download-section, .bg-gray-50 {
        display: none !important;
      }

      body {
        background: white !important;
      }

      #print-content {
        display: block !important;
        page-break-after: avoid;
      }
    }
  </style>

  <script>
    import QRCodeStyling from 'qr-code-styling';

    // Use the logo from public directory for client-side access
    const logoSrc = '/logo.png';

    let qrCode: QRCodeStyling | null = null;
    let currentSubdomain = '';

    // DOM elements
    const subdomainInput = document.getElementById('subdomain-input') as HTMLInputElement;
    const generateBtn = document.getElementById('generate-btn');
    const urlPreview = document.getElementById('url-preview');
    const qrContainer = document.getElementById('qr-container');
    const downloadSection = document.getElementById('download-section');
    const downloadPngBtn = document.getElementById('download-png');
    const downloadSvgBtn = document.getElementById('download-svg');
    const printBtn = document.getElementById('print-btn');
    const printQr = document.getElementById('print-qr');
    const printUrl = document.getElementById('print-url');

    // Update URL preview as user types
    subdomainInput?.addEventListener('input', () => {
      const subdomain = subdomainInput.value || 'mittfirma';
      if (urlPreview) {
        urlPreview.textContent = `https://${subdomain}.export.fish`;
      }
    });

    // Generate QR code
    function generateQRCode(subdomain: string) {
      if (!subdomain) {
        alert('Vennligst skriv inn et subdomene');
        return;
      }

      currentSubdomain = subdomain;
      const url = `https://${subdomain}.export.fish`;

      // Clear container
      if (qrContainer) {
        qrContainer.innerHTML = '';
      }

      // Create new QR code
      qrCode = new QRCodeStyling({
        width: 300,
        height: 300,
        type: 'canvas',
        data: url,
        image: logoSrc,
        dotsOptions: {
          color: '#1e40af',
          type: 'rounded'
        },
        backgroundOptions: {
          color: '#ffffff',
        },
        imageOptions: {
          crossOrigin: 'anonymous',
          margin: 8,
          imageSize: 0.4
        },
        cornersSquareOptions: {
          color: '#1e40af',
          type: 'extra-rounded'
        },
        cornersDotOptions: {
          color: '#1e40af',
          type: 'dot'
        }
      });

      // Append to container
      if (qrContainer) {
        qrCode.append(qrContainer);
      }

      // Show download section
      if (downloadSection) {
        downloadSection.classList.remove('hidden');
      }

      // Update print content
      if (printUrl) {
        printUrl.textContent = url;
      }
    }

    // Generate button click
    generateBtn?.addEventListener('click', () => {
      const subdomain = subdomainInput?.value?.trim();
      if (subdomain) {
        generateQRCode(subdomain);
      }
    });

    // Enter key in input
    subdomainInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const subdomain = subdomainInput?.value?.trim();
        if (subdomain) {
          generateQRCode(subdomain);
        }
      }
    });

    // Download PNG
    downloadPngBtn?.addEventListener('click', () => {
      if (qrCode) {
        qrCode.download({
          name: `qr-${currentSubdomain}`,
          extension: 'png'
        });
      }
    });

    // Download SVG
    downloadSvgBtn?.addEventListener('click', () => {
      if (qrCode) {
        qrCode.download({
          name: `qr-${currentSubdomain}`,
          extension: 'svg'
        });
      }
    });

    // Print
    printBtn?.addEventListener('click', () => {
      if (qrCode && printQr) {
        // Clone QR code for print
        printQr.innerHTML = '';
        const printQRCode = new QRCodeStyling({
          width: 400,
          height: 400,
          type: 'canvas',
          data: `https://${currentSubdomain}.export.fish`,
          image: logoSrc,
          dotsOptions: {
            color: '#1e40af',
            type: 'rounded'
          },
          backgroundOptions: {
            color: '#ffffff',
          },
          imageOptions: {
            crossOrigin: 'anonymous',
            margin: 8,
            imageSize: 0.4
          },
          cornersSquareOptions: {
            color: '#1e40af',
            type: 'extra-rounded'
          },
          cornersDotOptions: {
            color: '#1e40af',
            type: 'dot'
          }
        });
        printQRCode.append(printQr);

        // Trigger print after a short delay to ensure QR renders
        setTimeout(() => {
          window.print();
        }, 300);
      }
    });

    // Auto-generate if subdomain is in URL
    if (subdomainInput?.value) {
      generateQRCode(subdomainInput.value);
    }
  </script>
</Layout>
