---
import Layout from '../layouts/Layout.astro';
---

<Layout
  title="QR-kode Generator - export.fish"
  description="Generer QR-kode for din export.fish app"
  noindex
>
  <main class="min-h-screen bg-gray-50 pt-44 md:pt-52 pb-16 px-4">
    <div class="max-w-2xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">
          QR-kode
        </h1>
        <p class="text-lg text-gray-600 max-w-lg mx-auto">
          Print den ut og heng den opp et synlig sted for gjestene dine, eller bare send dem lenken til appen din.
        </p>
        <p id="url-display" class="text-lg font-mono font-semibold text-blue-600 mt-4"></p>
      </div>

      <!-- QR Code Display -->
      <div class="bg-white rounded-lg shadow-lg p-4 sm:p-8 mb-8">
        <div id="qr-container" class="flex justify-center items-center [&>canvas]:max-w-full [&>canvas]:h-auto">
          <div class="text-center text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
            </svg>
            <p class="text-lg font-medium">Mangler subdomene parameter</p>
            <p class="text-sm mt-2">Bruk: /qr?subdomain=dittfirma</p>
          </div>
        </div>
      </div>

      <!-- Download Button -->
      <div id="download-section" class="hidden text-center">
        <button
          id="download-btn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-semibold transition-colors inline-flex items-center gap-2 cursor-pointer"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          Last ned
        </button>
      </div>
    </div>
  </main>

  <script>
    import QRCodeStyling from 'qr-code-styling';

    // Use the high-res favicon for QR code embedding
    const logoSrc = '/favicon-512x512.png';

    let qrCode: QRCodeStyling | null = null;
    let currentSubdomain = '';

    // DOM elements
    const qrContainer = document.getElementById('qr-container');
    const downloadSection = document.getElementById('download-section');
    const downloadBtn = document.getElementById('download-btn');
    const urlDisplay = document.getElementById('url-display');

    // Generate QR code
    function generateQRCode(subdomain: string) {
      currentSubdomain = subdomain;
      const url = `https://${subdomain}.export.fish`;

      // Update URL display
      if (urlDisplay) {
        urlDisplay.textContent = url;
      }

      // Clear container
      if (qrContainer) {
        qrContainer.innerHTML = '';
      }

      // Create new QR code
      qrCode = new QRCodeStyling({
        width: 512,
        height: 512,
        type: 'canvas',
        data: url,
        image: logoSrc,
        dotsOptions: {
          color: '#1e40af',
          type: 'dots'
        },
        qrOptions: {
          errorCorrectionLevel: 'H'
        },
        backgroundOptions: {
          color: '#ffffff',
        },
        imageOptions: {
          crossOrigin: 'anonymous',
          margin: 5,
          imageSize: 0.5
        },
        cornersSquareOptions: {
          color: '#1e40af',
          type: 'dot'
        },
        cornersDotOptions: {
          color: '#1e40af',
          type: 'dot'
        }
      });

      // Append to container
      if (qrContainer) {
        qrCode.append(qrContainer);
      }

      // Show download section
      if (downloadSection) {
        downloadSection.classList.remove('hidden');
      }
    }

    // Download PNG
    downloadBtn?.addEventListener('click', () => {
      if (qrCode) {
        qrCode.download({
          name: `qr-${currentSubdomain}`,
          extension: 'png'
        });
      }
    });

    // Auto-generate if subdomain is in URL
    const urlParams = new URLSearchParams(window.location.search);
    const subdomainParam = urlParams.get('subdomain');
    if (subdomainParam) {
      generateQRCode(subdomainParam);
    }
  </script>
</Layout>
